@model HotelReservationApp.Models.ReservationViewModel
@using Microsoft.AspNetCore.Antiforgery
@inject IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Create Reservation";
}
@functions {
    public string GetAntiForgeryToken()
    {
        return Antiforgery.GetAndStoreTokens(Context).RequestToken;
    }
}

<div class="container-xxl py-5">
    <div class="container">
        <div class="text-center wow fadeInUp" data-wow-delay="0.1s">
            <h6 class="section-title text-center text-primary text-uppercase">Reservation</h6>
            <h1 class="mb-5">Create <span class="text-primary text-uppercase">Reservation</span></h1>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Reservation Details</h5>
                    </div>
                    <div class="card-body">
                        <form id="reservationForm" action="/Reservation/Create" method="post">
                            <input type="hidden" name="__RequestVerificationToken" value="@GetAntiForgeryToken()" />
                            <input type="hidden" name="RoomID" value="@Model.RoomID" id="RoomID" />
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="CheckInDate" class="form-label">Check-in Date</label>
                                    <input type="date" id="CheckInDate" name="CheckInDate" class="form-control" 
                                           value="@Model.CheckInDate.ToString("yyyy-MM-dd")" 
                                           min="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                                    <span class="text-danger field-validation-error" data-valmsg-for="CheckInDate"></span>
                                </div>
                                <div class="col-md-6">
                                    <label for="CheckOutDate" class="form-label">Check-out Date</label>
                                    <input type="date" id="CheckOutDate" name="CheckOutDate" class="form-control" 
                                           value="@Model.CheckOutDate.ToString("yyyy-MM-dd")" 
                                           min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")" required />
                                    <span class="text-danger field-validation-error" data-valmsg-for="CheckOutDate"></span>
                                </div>
                                <div class="col-md-6">
                                    <label for="GuestCount" class="form-label">Number of Guests</label>
                                    <select id="GuestCount" name="GuestCount" class="form-select" required>
                                        @for (int i = 1; i <= 6; i++)
                                        {
                                            string text = i == 1 ? "1 Guest" : i + " Guests";
                                            if (Model.GuestCount == i)
                                            {
                                                <option value="@i" selected>@text</option>
                                            }
                                            else
                                            {
                                                <option value="@i">@text</option>
                                            }
                                        }
                                    </select>
                                    <span class="text-danger field-validation-error" data-valmsg-for="GuestCount"></span>
                                </div>
                                <div class="col-md-6">
                                    <label for="SpecialRequests" class="form-label">Special Requests</label>
                                    <textarea id="SpecialRequests" name="SpecialRequests" class="form-control" rows="3" 
                                              placeholder="Any special requests or notes...">@Model.SpecialRequests</textarea>
                                    <span class="text-danger field-validation-error" data-valmsg-for="SpecialRequests"></span>
                                </div>
                            </div>

                            <div class="text-danger validation-summary-errors mt-3"></div>

                            <div class="d-flex justify-content-between mt-4">
                                <a href="/Room" class="btn btn-secondary">
                                    <i class="fa fa-arrow-left me-2"></i>Back to Rooms
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-check me-2"></i>Create Reservation
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Room Information</h5>
                    </div>
                    <div class="card-body">
                        @if (ViewBag.Room != null)
                        {
                            var room = ViewBag.Room as HotelReservationApp.Models.Room;
                            <div class="text-center mb-3">
                                @if (room.RoomImages != null && room.RoomImages.Any())
                                {
                                    <img src="@room.RoomImages.First().ImageUrl" class="img-fluid rounded" alt="@room.RoomType?.TypeName">
                                }
                                else
                                {
                                    <img src="~/img/room-1.jpg" class="img-fluid rounded" alt="@room.RoomType?.TypeName">
                                }
                            </div>
                            <h6 class="text-primary">@room.RoomType?.TypeName</h6>
                            <p class="mb-2"><strong>Hotel:</strong> @room.Hotel?.Name</p>
                            <p class="mb-2"><strong>Room Number:</strong> @room.RoomNumber</p>
                            <p class="mb-2"><strong>Capacity:</strong> @room.Capacity Persons</p>
                            <p class="mb-2"><strong>Price per Night:</strong> $@room.PricePerNight</p>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span><strong>Total Nights:</strong></span>
                                <span id="totalNights">1</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span><strong>Total Amount:</strong></span>
                                <span id="totalAmount" class="text-primary fw-bold">$@room.PricePerNight</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const checkInInput = $('#CheckInDate');
            const checkOutInput = $('#CheckOutDate');
            const totalNightsSpan = $('#totalNights');
            const totalAmountSpan = $('#totalAmount');
            const pricePerNight = @(ViewBag.Room?.PricePerNight ?? 0);

            function updateTotal() {
                const checkIn = new Date(checkInInput.val());
                const checkOut = new Date(checkOutInput.val());
                
                if (checkIn && checkOut && checkOut > checkIn) {
                    const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                    const total = nights * pricePerNight;
                    
                    totalNightsSpan.text(nights);
                    totalAmountSpan.text('$' + total.toFixed(2));
                }
            }

            checkInInput.on('change', function() {
                const checkIn = new Date(this.value);
                const minCheckOut = new Date(checkIn);
                minCheckOut.setDate(minCheckOut.getDate() + 1);
                checkOutInput.attr('min', minCheckOut.toISOString().split('T')[0]);
                updateTotal();
            });

            checkOutInput.on('change', updateTotal);

            // Setup AJAX anti-forgery token
            $.ajaxSetup({
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                }
            });

            // Form submit event listener
            $('#reservationForm').on('submit', function(e) {
                e.preventDefault();
                
                // Form verilerini doğrula
                const checkInStr = $('#CheckInDate').val();
                const checkOutStr = $('#CheckOutDate').val();
                const checkInDate = new Date(checkInStr);
                const checkOutDate = new Date(checkOutStr);
                
                console.log('CheckInDate string:', checkInStr);
                console.log('CheckOutDate string:', checkOutStr);
                console.log('CheckInDate object:', checkInDate);
                console.log('CheckOutDate object:', checkOutDate);
                
                if (checkOutDate <= checkInDate) {
                    toastr.error('Çıkış tarihi, giriş tarihinden sonra olmalıdır.');
                    return false;
                }
                
                if (checkInDate < new Date().setHours(0,0,0,0)) {
                    toastr.error('Giriş tarihi geçmiş bir tarih olamaz.');
                    return false;
                }
                
                // Rezervasyon oluşturma işlemi için yükleniyor göstergesi
                const submitBtn = $(this).find('button[type="submit"]');
                const originalBtnText = submitBtn.html();
                submitBtn.html('<i class="fa fa-spinner fa-spin me-2"></i>İşleniyor...');
                submitBtn.prop('disabled', true);
                
                // Form verilerini manuel olarak topla
                const formValues = {
                    RoomID: parseInt($('#RoomID').val(), 10),
                    CheckInDate: $('#CheckInDate').val(),
                    CheckOutDate: $('#CheckOutDate').val(),
                    GuestCount: parseInt($('#GuestCount').val(), 10),
                    SpecialRequests: $('#SpecialRequests').val() || ''
                };
                
                console.log('Manuel form verileri:', formValues);
                
                // AJAX isteği
                $.ajax({
                    url: $(this).attr('action'),
                    method: 'POST',
                    data: formValues,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    beforeSend: function (xhr) {
                        console.log('Token:', $('input[name="__RequestVerificationToken"]').val());
                        $('#submitBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> İşleniyor...');
                    },
                    success: function(response) {
                        console.log('Başarılı yanıt:', response);
                        console.log('Yanıt tipi:', typeof response);
                        
                        // Yanıt bir string ise, JSON olarak ayrıştırmayı dene
                        if (typeof response === 'string') {
                            try {
                                response = JSON.parse(response);
                                console.log('Ayrıştırılmış yanıt:', response);
                            } catch (e) {
                                console.error('Yanıt ayrıştırma hatası:', e);
                            }
                        }
                        
                        if (response && response.success) {
                            // Başarılı rezervasyon
                            toastr.success('Rezervasyon başarıyla oluşturuldu.');
                            $('.validation-summary-errors').empty();
                            
                            if (response.redirectTo) {
                                setTimeout(function() {
                                    window.location.href = response.redirectTo;
                                }, 1500);
                            }
                        } else {
                            // Sunucu tarafında doğrulama hatası
                            submitBtn.html(originalBtnText);
                            submitBtn.prop('disabled', false);
                            
                            const errorMessage = response && response.message ? response.message : 'Rezervasyon oluşturulurken bir hata oluştu.';
                            toastr.error(errorMessage);
                            console.log('Sunucu yanıtı (hata):', response);
                            
                            // Hata mesajını görüntüle
                            if (response && response.message) {
                                $('.validation-summary-errors').html('<ul><li>' + response.message + '</li></ul>');
                            } else if (response && response.errors) {
                                const errorMessages = [];
                                if (Array.isArray(response.errors)) {
                                    response.errors.forEach(function(error) {
                                        errorMessages.push('<li>' + error + '</li>');
                                    });
                                } else {
                                    Object.keys(response.errors).forEach(function(key) {
                                        const fieldErrors = response.errors[key];
                                        if (Array.isArray(fieldErrors)) {
                                            fieldErrors.forEach(function(error) {
                                                errorMessages.push('<li>' + error + '</li>');
                                            });
                                        } else {
                                            errorMessages.push('<li>' + fieldErrors + '</li>');
                                        }
                                    });
                                }
                                
                                if (errorMessages.length > 0) {
                                    $('.validation-summary-errors').html('<ul>' + errorMessages.join('') + '</ul>');
                                }
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        // Düğmeyi eski haline getir
                        submitBtn.html(originalBtnText);
                        submitBtn.prop('disabled', false);
                        
                        console.error('Rezervasyon oluşturma hatası:', xhr.responseText);
                        console.log('Status:', status);
                        console.log('Error:', error);
                        console.log('XHR Status:', xhr.status);
                        console.log('XHR Status Text:', xhr.statusText);
                        console.log('XHR Response Headers:', xhr.getAllResponseHeaders());
                        
                        // Yanıtı ayrıştırmayı dene
                        let responseData = null;
                        try {
                            if (xhr.responseText) {
                                responseData = JSON.parse(xhr.responseText);
                                console.log('Ayrıştırılmış hata yanıtı:', responseData);
                            }
                        } catch (e) {
                            console.error('Hata yanıtı ayrıştırma hatası:', e);
                        }
                        
                        // Hata mesajlarını işle
                        if (xhr.responseJSON && xhr.responseJSON.errors) {
                            const errorMessages = [];
                            
                            Object.keys(xhr.responseJSON.errors).forEach(function(key) {
                                const fieldErrors = xhr.responseJSON.errors[key];
                                if (Array.isArray(fieldErrors)) {
                                    fieldErrors.forEach(function(errorMsg) {
                                        toastr.error(errorMsg);
                                        errorMessages.push('<li>' + errorMsg + '</li>');
                                    });
                                    
                                    // Alan özel hata mesajlarını göster
                                    $('[data-valmsg-for="' + key + '"]').text(fieldErrors[0]);
                                } else if (typeof fieldErrors === 'string') {
                                    toastr.error(fieldErrors);
                                    errorMessages.push('<li>' + fieldErrors + '</li>');
                                    $('[data-valmsg-for="' + key + '"]').text(fieldErrors);
                                }
                            });
                            
                            // Özet hata mesajını göster
                            if (errorMessages.length > 0) {
                                $('.validation-summary-errors').html('<ul>' + errorMessages.join('') + '</ul>');
                            }
                        } else if (responseData && responseData.message) {
                            // API'den gelen hata mesajı
                            toastr.error(responseData.message);
                            $('.validation-summary-errors').html('<ul><li>' + responseData.message + '</li></ul>');
                        } else {
                            // Genel hata mesajı
                            const errorMsg = 'Rezervasyon oluşturulurken bir hata oluştu: ' + (xhr.responseText || error || xhr.statusText);
                            toastr.error(errorMsg);
                            $('.validation-summary-errors').html('<ul><li>' + errorMsg + '</li></ul>');
                        }
                        
                        // Hata durumunu konsola yazdır
                        console.log('Form verileri tekrar:', formValues);
                    }
                });
            });
        });
    </script>
}
